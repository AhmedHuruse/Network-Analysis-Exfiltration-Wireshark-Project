# ðŸ¥…ðŸ¦ˆ Network-Analysis-Exfiltration-Wireshark-Project

## Objective and Description
We will be conducting a lab on cyber defenders called Hawkeye Blue Team. This lab is a challenge on analyzing a packet capture with Wireshark to see how, when, where, and what was exfiltrated via the malicious email link that the user downloaded as victim of phishing. We will answer the many questions in this lab to successfully complete it and will learn hands on skills on PCAPS (Packet Captures) and network analysis.

### Skills Learned
- PCAP Analysis: Learned how to navigate the Wireshark panels. How to set up filters, follow network traces, and search for valuable analyical network traffic informtaion. This skill is essential in cybersecurity because it allows you to investigate under the hood of network traffic in order to asses an incident.
- Extracting files and using powershell to generate hashes
- Using OSINT (Open-Source Technology) to bridge the gap in my analysis and investigation
- What IOCs (Indicators of Compromise) to look for in networking
  
  

### Tools Used
- Vitualbox
- Windows 10
- Powershell
- Wireshark
- Virus Total
- CyberChef
- abuseipdb
- whois.domaintools.com
- ipinfo.io

## Steps
- Step 1: The challenge prompt states that " an accountant your organization has received and ivoice email with download link. After opening it, suspicious network traffic was observed. Your job is to investigate the network trace and analyze exfiltration attempts". We now download the files for the challenge and begin analyzing the PCAP with Wireshark. We start of by going through a few pages in the statistics tab. We first look at "Capture File Properties" and see the basic information of the capture. Things like the first and last capture, the duration in between them, the sha256 hash, and how many packets in the capture. We move on to the "Protocol Hierarchy" and this displays all of the protocols in all of the levels (OSI Layers) of the capture. Lastly, we go into the conversations page which allows us to see the top conversations and we can tell by sorting for bytes. Within the this page, we toggle to the IPv4, TCP, and UDP tabs to check for the noisiest IPs. This helps us zero in on the top IPs that have the most activity in the capture. The top 3 addresses that stand out are 217.182.138.150, 10.4.10.4, and 23.229.262.69.
  
  <img src="https://i.imgur.com/LQuMEkv.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/hYz4UXn.png" height="20%" width="20%" alt="Network Project Steps"/> <img src="https://i.imgur.com/GFQRCqk.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/QTzcKb2.png" height="20%" width="20%" alt="Network Analysis Project Steps"/>
- Step 2: The first coarse of aciton will be to search and filter for top address with the most traffic communications and it will be the external IP of 217.182.138.150. After we apply our search we see that there is an HTTP packet with a GET request from our user on packet #210 at the time of 8:37 pm. The info tab says to get /proforma/tkraw_Protected99.xex which is already very suspicous. We right click the packet to open to follow it with HTTP trace to find more info about the conversation between the external and our internal IP. It looks like a binary is being downloaded because of "MZ" stream and next to "Content-Type" it reads "application/x-msdownload". We will note this information and move on. Addisionally, we want to know what happened right before communication with the external IP started. We back out of the current search to the entire capture and see that the packet before #207 which is #206 had DNS response from our server to our internal IP that end in .132. The info beside it says there was "standard query response" for a domain called "proforma-invoices.com" . This could be the suspcious download link from before. We will note this domain.
  
  <img src="https://i.imgur.com/D5LZRgN.png" height="30%" width="30%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/yYdaczy.png" height="30%" width="30%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/vrDSTIO.png" height="30%" width="30%" alt="Network Analysis Project Steps"/>
- Step 3: Since one of the protocols that we took note of in our intial discovery was SMTP, this is most likely the next path to investigate. Especially because thr challlenge prompt said that the malicous link was sent via e-mail. So now we filter for SMTP on our search bar. We see that the connections to the mail server happened toward the tail end of the capture. We right click on the first packet of #317 yo follow the tcp stream. We can see that host name of the mail server is "secureserver.net" with version "Exim 4.91. We can also see our client machine is "Beijing-5cd1-PC" wit an IP address of "173.66.146.112". We ca also observe that an auth login attempt has been triggered and the characters are in base64 format known by the == at the end of the string. We use the OSINT tool CyberChef to decode these entries into plain text. We find out that the attacker user name is "sales.del@macwinlogistics.in" and the password is "Sales@23". With the attacker's account information, we can do OSINT on the domain for further investigation. We decode another line further down with cyberchef and see that the attacker is using a keylogger and has exfiltrated passwords from the user "roman.maguire" on the workstation we listed above. And towards the bottom we find a big block of data in base64 and we decode that and find that the user's passwords have been logged and taken. He is using a weak password for multiple different accounts like for his email and banking account. We also see the companies name and mail server name. 
  
  <img src="https://i.imgur.com/G8YtGKa.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/LEdvxnr.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/V2LhMzF.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/kjx1mI7.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> 
- Step 4: Next, we export the file from the previous step and generate a sha256 file hash so that we can  perform OSINT on it. We will use VirusTotal to search for the hash and the domain of "Proforma.invoices.com". We also use abuseipdb to search up the external IP with the most conversations which was 217.182.138.150. This gives us more information on the IPs location, ISP, UsageType, etc. The file hash when searched on VirusTotal returned that 60/72 security vendors have flagged it as malicous and the threat type was trojan. The domain proforma-invoices.com also results in multiple vendors flagging it as malicious. On abuseipdb, we search the external IP above and discover that it is located in a datacenter in France from an ISP of OVH SAS.
  
<img src="https://i.imgur.com/nIm6ojH.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/SwdCC3f.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/gADABC0.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/1wFO9Po.png" height="20%" width="20%" alt="Network Analysis Project Steps"/>

- Step 5: I believe we have gathered enough information in our investigation to go head and complete the challenge questions on CyberDefender. From thi step onwards, we will be answering the 24 questions. I will list the answers for Qs 1-9 here. Q1=4003, Q2=2019-04-10 20:37:07 utc, Q3=01:03:41, questions 1-3 are all under the "capture file properties" window under the statistics tab. Refer to the first picture in Step 1. Q4=00:08:02:1c:47:ae the answer is in the conversations window and then click ethernet because that is the data link laye (layer 2) and the MAC address is address A. Q5=Hewlett-Packard we can find the manufacturer of thr NIC of the computer by first 3 bytes of the MAC address and run it thorugh the Wireshark OUI lookup tool to see the manufacturer. Q6=Palo Alto this is the headquarters of the manufacturer of the NIC. Q7=3 we find this in the endpoints window under the statistics tab and we click on layer 2 so the IPv4 tab and sort it so that all the internal private IP addresses are at the top so in this case its 3 excluding the 4th broacasting IP. Q8=Beijing-5cd1-PC this is the users host name and you can refer to the first picture in Step 3 to find this. Q9=10.4.10.4 we can find this by filtering for DNS in the search bar and seein that there are two IPs. We know that one is our internal IP so the other must be the IP of the organization's DNS server. 
  
   <img src="https://i.imgur.com/xfOLD5C.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/pusugiG.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/iwuaQbe.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/n2JU6H8.png" height="20%" width="20%" alt="Network Analysis Project Steps"/>
- Step 6: This step will list answers for Qs 10-19. Q10=Proforma-invoices.com this is the domain the victim asked for; refer to picture 3 of Step 2. Q11=217.182.138.150 we can find this by looking at the bottom panel, we expand the answers button and see the IP address. Q12=France we saw this in the abuseipdb tool; refer to the 4th picture in step 4. Q13=Windows NT 6.1 we can find this in the first HTTP stream we did and it is next to the User-Agent entry; refer to the second picture in Step 2. Q14=tkraw_Protected99.exe this is also found in the first HTTP request stream we looked at and its on the first line of the page; refer to the second picture in Step 2. Q15=71826BA081E303866CE2A2534491A2F7 we go back to the file we exported and made sha256 hash in powershell in Step 4 and make an MD5 hash instead. Q16=Lite speed his is also found in the first HTTP request stream we looked at and it next to the server entry in the blue response; refer to the second picture in Step 2. Q17=173.66.146.112 we can look bacj into our SMTP stream and can find the user's host public IP right next to the host name; refer to the first picture in Step 3. Q18=United States we can take a look at the output for the SMTP filter and see that there is another IP communicating with our internal IP and that is 23.229.162.69. We put this IP into the OSINT tool ipinfo.io and see which country the stolen information is sent to. Q19=Exim 4.91 is the software that runs the email server the stolen information was sent to and we know this by looking at the first line of SMTP traffic page; refer to the first picture in Step 3. 
  
  <img src="https://i.imgur.com/O9B5DEn.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/KoBnNuY.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/gYwBttT.png" height="20%" width="20%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/imcBXDE.png" height="20%" width="20%" alt="Network Analysis Project Steps"/>

-Step 7: Here, we will finish up the rest of the challenge questions Qs 20-24. Q20=sales.del@macwinlogistics.in we know this by looking at the MAIL FROM or RCPT TO entry and looking right next to them. This is in the SMTP traffic page; refer to the first picture in Step 3. Q21=Sales@23 is the password used to send the malicious e-mail; this is also in the SMTP traffic page but the text is in base64 and needs to be decoded with CyberChef; refer to the third picture in Step 3 to see the password in plain text. Q22=Reborn V9 this is a malware variant of the hawkeye keylogger; refer to the top of the fourth picture in Step 3. Q23=roman.mcguire:P@ssw0rd$ this also found when decoding the big chunk of data at the bottom fo the SMTP traffic page; refer to near the bottom of the fourth picture in step 3. Q24=10 looking at the search page of SMTP PCAP we see a trend that the data is exfiltrated regularly if we subrtact the time between each new wave of exfiltration, we can see that it happens every 10 minutes. Focus on when the info section of the packet says DATA FRAGMENT and record the time elapsed of when the next wave of DATA FRAGMENT packets appear; refer to the third picture in Step 6. The questions and challenge have been completed successfully.

<img src="https://i.imgur.com/1EMU2AI.png" height="40%" width="40%" alt="Network Analysis Project Steps"/> <img src="https://i.imgur.com/YRfiNzw.png" height="40%" width="40%" alt="Network Analysis Project Steps"/>




